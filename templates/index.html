<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>News Download</title>
</head>
<body>
    <header class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm">
      <p class="h5 my-0 me-md-auto fw-normal">CryptoNews</p>
      <nav class="my-2 my-md-0 me-md-3">
        <a class="p-2 text-dark" href="#">Features</a>
        <a class="p-2 text-dark" href="#">Support</a>
      </nav>
      <a class="btn btn-outline-primary" href="http://localhost:8080/authorize">Google Authorization</a>
      <div id="userinfo" style="display: inline; padding-left: 25px"></div>
    </header>
    <main class="container">
        <div id="upper" class="row row-cols-1 row-cols-md-1 mb-1 text-left">

            <div class="col">
                <div class="card mb-4 shadow-sm">
                    <div class="card-header">
                        <h4 class="my-0 fw-normal">Search News</h4>
                    </div>
                    <div class="card-body">
                        <form method="post">
                            <label for="from_date" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="from_date" name="from_date">
                            <label for="to_date" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="to_date" name="to_date">
                            <br>
                            <label>Please select type of news:</label><br>

                            <div class="btn-group btn-group-toggle" data-toggle="buttons">
                              <label class="btn btn-secondary active">
                                    <input type="radio" name="news_type"
                                           id="crypto_news"
                                           value="crypto_news" onclick="toggleComponents('#crypto_news_component','#token_news_component');"> Crypto News
                              </label>
                              <label class="btn btn-secondary">
                                <input type="radio" name="news_type"
                                       id="token_news"
                                       value="token_news" onclick="toggleComponents('#token_news_component','#crypto_news_component');"> Token News
                              </label>
                            </div>
                            <div class="collapse" id="crypto_news_component">
                              <div class="">
                                  <br>
                                  <button type="button" class="btn btn-primary" id="search" name="search" onclick="searchNews();">Search</button>
                                  <button type="button" class="btn btn-primary" id="test" onclick="testTable();">Test</button>
                              </div>
                            </div>
                            <div class="collapse" id="token_news_component">
                              <div class="">
                                  <br>

                                  <input type="checkbox" id="marketIndexTokens" checked autocomplete="off" onclick="toggleTokensSelect('#marketIndexTokens','.market-token');">
                                  <label for="marketIndexTokens">Market Index Tokens: </label>
                                  <input type="checkbox" class="token market-token" checked autocomplete="off" value="BTC">BTC
                                  <input type="checkbox" class="token market-token" checked autocomplete="off" value="ETH">ETH
                                  <input type="checkbox" class="token market-token" checked autocomplete="off" value="XRP">XRP
                                  <input type="checkbox" class="token market-token" checked autocomplete="off" value="XLM">XLM
                                  <input type="checkbox" class="token market-token" checked autocomplete="off" value="DOT">DOT
                                  <input type="checkbox" class="token market-token" checked autocomplete="off" value="EOS">EOS
                                  <input type="checkbox" class="token market-token" checked autocomplete="off" value="CRO">CRO
                                  <input type="checkbox" class="token market-token" checked autocomplete="off" value="ATOM">ATOM
                                  <input type="checkbox" class="token market-token" checked autocomplete="off" value="XTZ">XTZ
                                  <input type="checkbox" class="token market-token" checked autocomplete="off" value="LINK">LINK
                                  <input type="checkbox" class="token market-token" checked autocomplete="off" value="ADA">ADA
                                  <input type="checkbox" class="token market-token" checked autocomplete="off" value="XMR">XMR
                                  <br>

                                  <input type="checkbox" id="defiIndexTokens" checked autocomplete="off" onclick="toggleTokensSelect('#defiIndexTokens','.defi-token');">
                                  <label for="defiIndexTokens">DeFi Index Tokens: </label>
                                  <input type="checkbox" class="token defi-token" checked autocomplete="off" value="AAVE">AAVE
                                  <input type="checkbox" class="token defi-token" checked autocomplete="off" value="BAL">BAL
                                  <input type="checkbox" class="token defi-token" checked autocomplete="off" value="COMP">COMP
                                  <input type="checkbox" class="token defi-token" checked autocomplete="off" value="CRV">CRV
                                  <input type="checkbox" class="token defi-token" checked autocomplete="off" value="LINK">LINK
                                  <input type="checkbox" class="token defi-token" checked autocomplete="off" value="LRC">LRC
                                  <input type="checkbox" class="token defi-token" checked autocomplete="off" value="MKR">MKR
                                  <input type="checkbox" class="token defi-token" checked autocomplete="off" value="NXM">NXM
                                  <input type="checkbox" class="token defi-token" checked autocomplete="off" value="REN">REN
                                  <input type="checkbox" class="token defi-token" checked autocomplete="off" value="SNX">SNX
                                  <input type="checkbox" class="token defi-token" checked autocomplete="off" value="UMA">UMA
                                  <input type="checkbox" class="token defi-token" checked autocomplete="off" value="UNI">UNI
                                  <input type="checkbox" class="token defi-token" checked autocomplete="off" value="YFI">YFI
                                  <br><br>
                                  <button type="button" class="btn btn-primary" id="download" onclick="downloadTokenNews();">Download</button>
                              </div>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </div>

    <div id="news-board" class="row row-cols-1 row-cols-md-1 mb-1 text-left">
        <div class="col">
            <div class="card mb-4 shadow-sm">
                <div class="card-header">
                    <h4 class="my-0 fw-normal">News</h4>
                </div>
                <div class="card-body">
                    <table id="news-table"
                           data-search="true"
                           data-height="500"
                           data-virtual-scroll="true"
                           data-total-field="count">
                      <thead>
                        <tr>
                            <th data-field="label" data-checkbox="true">Upload</th>
                            <th data-field="date" data-formatter="dateFormatter" data-width="15" data-width-unit="%">Date</th>
                            <th data-field="title" data-width="35" data-width-unit="%">Title</th>
                            <th data-field="tags" data-width="15" data-width-unit="%" data-formatter="textFormatter">Tags</th>
                            <th data-field="certainty_num" data-width="10" data-width-unit="%" data-formatter="numberFormatter">Certainty</th>
                            <th data-field="impact" data-width="15" data-width-unit="%" data-formatter="optionFormatter">Impact</th>
                            <th data-field="url" data-width="5" data-width-unit="%" data-formatter="urlFormatter">URL</th>
                        </tr>
                      </thead>
                    </table>
                    <br>
                    <button type="button" class="btn btn-primary" id="upload" data-toggle="modal" data-target="#uploadConfirmDlg" onclick="saveNews();">Upload News</button>
                </div>
            </div>
        </div>
    </div>
    </main>

    <div class="modal fade" id="loading" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="d-flex justify-content-center">
          <div class="spinner-border text-success" role="status">
            <span class="sr-only">Loading...</span>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="uploadConfirmDlg" tabindex="-1" role="dialog" aria-labelledby="uploadConfirmDlgLabel" data-backdrop="static" data-keyboard="false" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="uploadConfirmDlgLabel">Confirm to upload?</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            Before uploading, make sure that you have logined Google.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="uploadNews();">Confirm</button>
          </div>
        </div>
      </div>
    </div>
</body>
<style>
    #container{
        max-width: 1000px;
    }
</style>
<link rel="stylesheet" href="../static/font-awesome-4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="../static/bootstrap-table/bootstrap-table.min.css">
<link rel="stylesheet" href="../static/bootstrap-4.5.3-dist/css/bootstrap.min.css">
<link rel="stylesheet" href="../static/bootstrap-4.5.3-dist/css/bootstrap-grid.min.css">
<link rel="stylesheet" href="../static/bootstrap-4.5.3-dist/css/bootstrap-reboot.min.css">
<link rel="stylesheet" href="../static/bootstrap4-editable/bootstrap-editable.css">

<script type="application/javascript" src="../static/jquery-3.5.1.min.js"></script>
<script type="application/javascript" src="../static/popper.min.js"></script>

<script type="application/javascript" src="../static/bootstrap-4.5.3-dist/js/bootstrap.bundle.min.js"></script>
<script type="application/javascript" src="../static/bootstrap-4.5.3-dist/js/bootstrap.min.js"></script>
<script type="application/javascript" src="../static/bootstrap4-editable/bootstrap-editable.min.js"></script>


<script src="../static/bootstrap-table/bootstrap-table.min.js"></script>
<script src="../static/bootstrap-table/bootstrap-table-editable.min.js"></script>



<script>
    var today = new Date().toISOString().split("T")[0];
    $("#from_date").val(today);
    $("#to_date").val(today);

    $table = $("#news-table");
    $table.bootstrapTable();

    function toggleComponents(showId,hideId){
        $(showId).collapse('show');
        $(hideId).collapse('hide');
    }
    function toggleTokensSelect(id, tokenClass){
        let isChecked = $(id).prop('checked');
        if(isChecked){
            $(tokenClass).prop('checked',true);
        }else{
            $(tokenClass).prop('checked',false);
        }
    }

    var tableData = localStorage.getItem('last_news');
    if(tableData){
        try{
            tableData = JSON.parse(tableData);
            loadNewsData(tableData);
        }catch (e) {
            tableData = [];
        }
    }else{
        tableData = [];
    }

    const IS_TEST = false;

    if(!IS_TEST){
        $("#test").hide();
    }

    function getParams(name){
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        if (results&&results.length>0){
            return results[1].replace("+"," ") || 0;
        }
        return "";
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    var userName=getParams("user");

    if(userName){
        $("#userinfo").html('Hello, '+ userName);
    }

    function testTable(){
        $.getJSON("../static/data.json", function (mydata){
            tableData = mydata;
            loadNewsData(mydata);
        });

    }

    function loadNewsData(data){
        $("#news-table").bootstrapTable('load', data);
    }

    function optionFormatter(value, row, index){
        let name = "impact-"+row["id"];
        let innerHtml = `<input type="radio" name=${name} value="positive" onselect="setValueToData('impact','positive',${index})"> Positive <br>`+
              `<input type="radio" name=${name} value="neutral" onselect="setValueToData('impact','neutral',${index})"> Neutral <br>`+
              `<input type="radio" name=${name} value="negative" onselect="setValueToData('impact','negative',${index})"> Negative <br>`;
        $("input[name='impact-theblock-93723']:checked").val();
        return innerHtml;
    }

    function textFormatter(value, row, index){
        return `<input value=${value} onblur="setObjToData('tags',this,${index})">`;
    }

    function numberFormatter(value, row, index){
        value=100;
        return `<input type="number" value=${value} onblur="setObjToData('certainty_num',this,${index})" min="0">`;
    }

    function setValueToData(field, value, index){
        tableData[index][field] = value;
    }

    function setObjToData(field, obj, index){
        tableData[index][field] = $(obj).val();
    }

    function urlFormatter(value){
        return "<a href='"+value+"' target='#'>url</a>";
    }

    function dateFormatter(value){
        let d = new Date(value);
        return d.toISOString().split('T')[0];
    }

    function searchNews(){
        $("#loading").modal("show");
        let newsType = $("input[name='news_type']:checked").val();
        $.ajax(
            {
                url: "http://localhost:8080/search",
                method:  "POST",
                data: {
                    "from_date":$("#from_date").val(),
                    "to_date":$("#to_date").val(),
                    "news_type":newsType,
                },
                dataType:"json",
                success:function (data){
                    tableData=data;
                    loadNewsData(tableData);
                    $("#loading").modal("hide");
                },
                complete:function (){
                    $("#loading").modal("hide");
                }
            }
        );
    }
    function downloadTokenNews(){
        $("#loading").modal("show");
        let newsType = $("input[name='news_type']:checked").val();
        let tokens = [];
        if(newsType==="token_news"){
            let tokenList = $(".token:checked");
            for(let i=0;i<tokenList.length;i++){
                tokens.push(tokenList[i].value);
            }
        }
        $.ajax(
            {
                url: "http://localhost:8080/download",
                method:  "POST",
                data: {
                    "from_date":$("#from_date").val(),
                    "to_date":$("#to_date").val(),
                    "news_type":newsType,
                    "tokens": JSON.stringify(tokens),
                },
                dataType:"text",
                success:function (data){
                    let blob=new Blob([data]);
                    let link=document.createElement('a');
                    link.href=window.URL.createObjectURL(blob);
                    link.download="token_news.csv";
                    link.click();
                },
                complete:function (){
                    $("#loading").modal("hide");
                }
            }
        );
    }

    function saveNews(){
        tableData = $("#news-table").bootstrapTable('getData');
        localStorage.setItem("last_news", JSON.stringify(tableData));
    }

    function uploadNews(){
        $('#uploadConfirmDlg').modal('hide');
        var selectedCount=0;
        tableData = $("#news-table").bootstrapTable('getData');
        for(let i=0; i<tableData.length; i++){
            if(tableData[i]["label"]===true){
                selectedCount++;
            }
        }
        if(selectedCount===0){
            alert("You haven't select any data");
            return;
        }

        uploadToGoogle(tableData);

    }
    function uploadToGoogle(news){
        fromDate = $("#from_date").val();
        toDate = $("#to_date").val();

        if(!fromDate&&!toDate){
            fromDate = new Date().toISOString();
            toDate = fromDate;
        }

        $.ajax(
            {
                url: "http://localhost:8080/upload",
                method:  "POST",
                data: {
                    "data": JSON.stringify(news),
                    'filename': "news("+fromDate+"-"+toDate+").json"
                },
                dataType:"json",
                success: function(response){
                    alert(response.responseText);
                },
                complete: function(response){
                    alert(response.responseText);
                }
            }
        );
    }
</script>
</html>